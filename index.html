// В начало скрипта добавляем новую константу
const mult2 = 1.7;  // Новый коэффициент для второго канала

// В объект chart.data.datasets добавляем два новых набора данных (после существующих upper/lower/middle):
{
    label: 'Upper Envelope 1.7',
    data: [],
    borderColor: '#00ff00',  // Зеленый цвет для отличия
    borderWidth: 1,
    pointRadius: 0,
    fill: false
},
{
    label: 'Lower Envelope 1.7',
    data: [],
    borderColor: '#ff00ff',  // Фуксия для отличия
    borderWidth: 1,
    pointRadius: 0,
    fill: false
},

// Модифицируем функцию updateChart():
function updateChart() {
    console.log("Candles updated:", candles.length);

    const displayCandles = candles.slice(-maxCandles);
    const displayClosePrices = closePrices.slice(-maxCandles);

    const upperWicks = [];
    const lowerWicks = [];
    displayCandles.forEach(c => {
        if (c.h > Math.max(c.o, c.c)) {
            upperWicks.push({ x: c.x, y: c.h });
            upperWicks.push({ x: c.x, y: Math.max(c.o, c.c) });
            upperWicks.push({ x: c.x, y: null });
        }

        if (c.l < Math.min(c.o, c.c)) {
            lowerWicks.push({ x: c.x, y: Math.min(c.o, c.c) });
            lowerWicks.push({ x: c.x, y: c.l });
            lowerWicks.push({ x: c.x, y: null });
        }
    });

    // Расчет для первого канала (mult = 2.89)
    const { nwe, sae } = calculateNWE(closePrices);
    const displayNwe = nwe.slice(-maxCandles);
    const upper = displayNwe.map((v, i) => ({ x: displayCandles[i]?.x, y: v + sae }));
    const lower = displayNwe.map((v, i) => ({ x: displayCandles[i]?.x, y: v - sae }));
    const middle = displayNwe.map((v, i) => ({ x: displayCandles[i]?.x, y: v }));

    // Расчет для второго канала (mult = 1.7)
    const sae2 = (sae / Math.min(499, closePrices.length - 1)) * mult2;  // Новый SAE с mult2
    const upper2 = displayNwe.map((v, i) => ({ x: displayCandles[i]?.x, y: v + sae2 }));
    const lower2 = displayNwe.map((v, i) => ({ x: displayCandles[i]?.x, y: v - sae2 }));

    const ema100 = calculateEMA(closePrices, 100).slice(-maxCandles);
    const ema200 = calculateEMA(closePrices, 200).slice(-maxCandles);
    const ema100Data = ema100.map((v, i) => ({ x: displayCandles[i]?.x, y: v }));
    const ema200Data = ema200.map((v, i) => ({ x: displayCandles[i]?.x, y: v }));

    const annotations = displayCandles.map((c, i) => ({
        type: 'box',
        xMin: c.x.getTime() - 300000,
        xMax: c.x.getTime() + 300000,
        yMin: Math.min(c.o, c.c),
        yMax: Math.max(c.o, c.c),
        backgroundColor: c.o <= c.c ? '#00c4b4' : '#ff1744',
        borderColor: '#ffffff',
        borderWidth: 1
    }));

    const lastCandleTime = displayCandles.length > 0 ? displayCandles[displayCandles.length - 1].x.getTime() : Date.now();
    const offsetTime = lastCandleTime + 900000;

    const lastPriceData = lastPrice && lastPriceTime ? [
        { x: displayCandles[0]?.x, y: lastPrice },
        { x: new Date(lastCandleTime), y: lastPrice }
    ] : [];

    if (lastPrice && lastPriceTime) {
        document.getElementById('currentPrice').textContent = `Текущая цена: ${lastPrice.toFixed(4)}`;
    } else {
        document.getElementById('currentPrice').textContent = 'Текущая цена: N/A';
    }

    chart.options.scales.x.min = displayCandles.length > 0 ? displayCandles[0].x.getTime() : Date.now();
    chart.options.scales.x.max = offsetTime;

    chart.options.plugins.annotation.annotations = annotations;
    chart.data.datasets[0].data = upperWicks;
    chart.data.datasets[1].data = lowerWicks;
    chart.data.datasets[2].data = upper;
    chart.data.datasets[3].data = lower;
    chart.data.datasets[4].data = middle;
    chart.data.datasets[5].data = ema100Data;
    chart.data.datasets[6].data = ema200Data;
    chart.data.datasets[7].data = lastPriceData;
    chart.data.datasets[8].data = upper2;  // Новые данные для mult = 1.7
    chart.data.datasets[9].data = lower2;  // Новые данные для mult = 1.7
    chart.update();
    console.log("Chart updated");
}
