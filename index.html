<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDO/USDT 15m - Nadaraya-Watson Envelope</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { background-color: #1e222d; color: white; font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        canvas { max-width: 100%; }
    </style>
</head>
<body>
    <h1>LDO/USDT 15m - Nadaraya-Watson Envelope</h1>
    <canvas id="priceChart"></canvas>

    <script>
        console.log("Starting script...");

        const h = 8;
        const mult = 3;
        const repaint = true;
        const maxCandles = 126;

        const ctx = document.getElementById('priceChart').getContext('2d');
        console.log("Canvas context initialized:", ctx);

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Wick High',
                        data: [],
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        pointRadius: 0,
                        showLine: false
                    },
                    {
                        label: 'Wick Low',
                        data: [],
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        pointRadius: 0,
                        showLine: false
                    },
                    {
                        label: 'Upper Envelope',
                        data: [],
                        borderColor: '#00c4b4',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Lower Envelope',
                        data: [],
                        borderColor: '#ff1744',
                        borderWidth: 1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    annotation: {
                        annotations: []
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } },
                        title: { display: true, text: 'Time' }
                    },
                    y: { title: { display: true, text: 'Price (USDT)' } }
                }
            }
        });
        console.log("Chart initialized:", chart);

        function gauss(x, h) {
            return Math.exp(-(Math.pow(x, 2) / (h * h * 2)));
        }

        function calculateNWE(prices) {
            const nwe = [];
            let sae = 0;
            const minLength = Math.min(prices.length - 1, 499);

            for (let i = 0; i <= minLength; i++) {
                let sum = 0, sumw = 0;
                for (let j = 0; j <= minLength; j++) {
                    const w = gauss(i - j, h);
                    sum += prices[j] * w;
                    sumw += w;
                }
                const y = sum / sumw;
                sae += Math.abs(prices[i] - y);
                nwe.push(y);
            }
            sae = (sae / minLength) * mult;
            return { nwe, sae };
        }

        const candles = [];
        const closePrices = [];
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/ldousdt@kline_15m');
        console.log("WebSocket initialized:", ws);

        ws.onopen = () => {
            console.log("WebSocket connection opened");
        };

        ws.onmessage = (event) => {
            console.log("WebSocket message received:", event.data);
            const data = JSON.parse(event.data);
            if (data.k) {
                const timestamp = new Date(data.k.t);
                const candle = {
                    x: timestamp,
                    o: parseFloat(data.k.o),
                    h: parseFloat(data.k.h),
                    l: parseFloat(data.k.l),
                    c: parseFloat(data.k.c)
                };
                const closePrice = parseFloat(data.k.c);

                candles.push(candle);
                closePrices.push(closePrice);

                if (candles.length > maxCandles) {
                    candles.shift();
                    closePrices.shift();
                }

                console.log("Candles updated:", candles.length);

                const wicksHigh = candles.map(c => ({ x: c.x, y: c.h }));
                const wicksLow = candles.map(c => ({ x: c.x, y: c.l }));
                const { nwe, sae } = calculateNWE(closePrices);
                const upper = nwe.map((v, i) => ({ x: candles[i]?.x, y: v + sae }));
                const lower = nwe.map((v, i) => ({ x: candles[i]?.x, y: v - sae }));

                const annotations = candles.map((c, i) => ({
                    type: 'box',
                    xMin: c.x - 300000,
                    xMax: c.x + 300000,
                    yMin: Math.min(c.o, c.c),
                    yMax: Math.max(c.o, c.c),
                    backgroundColor: c.o <= c.c ? '#00c4b4' : '#ff1744',
                    borderColor: '#ffffff',
                    borderWidth: 1
                }));

                chart.options.plugins.annotation.annotations = annotations;
                chart.data.datasets[0].data = wicksHigh;
                chart.data.datasets[1].data = wicksLow;
                chart.data.datasets[2].data = upper;
                chart.data.datasets[3].data = lower;
                chart.update();
                console.log("Chart updated");
            }
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        ws.onclose = () => {
            console.log("WebSocket connection closed");
        };
    </script>
</body>
</html>
