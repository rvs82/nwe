<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nadaraya-Watson Envelope - LDO/USDT 15m</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #1e222d;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        canvas {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <h1>LDO/USDT 15m - Nadaraya-Watson Envelope</h1>
    <canvas id="priceChart"></canvas>

    <script>
        // Настройки индикатора
        const h = 8; // Bandwidth
        const mult = 3; // Multiplier
        const repaint = true; // Repainting Smoothing

        // Инициализация графика
        const ctx = document.getElementById('priceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Close Price',
                        data: [],
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Upper Envelope',
                        data: [],
                        borderColor: '#00c4b4', // teal
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Lower Envelope',
                        data: [],
                        borderColor: '#ff1744', // red
                        borderWidth: 1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Time' } },
                    y: { title: { display: true, text: 'Price (USDT)' } }
                }
            }
        });

        // Функция Гаусса
        function gauss(x, h) {
            return Math.exp(-(Math.pow(x, 2) / (h * h * 2)));
        }

        // Расчет Nadaraya-Watson Envelope
        function calculateNWE(prices) {
            const nwe = [];
            let sae = 0;
            const minLength = Math.min(499, prices.length - 1);

            for (let i = 0; i <= minLength; i++) {
                let sum = 0;
                let sumw = 0;
                for (let j = 0; j <= minLength; j++) {
                    const w = gauss(i - j, h);
                    sum += prices[j] * w;
                    sumw += w;
                }
                const y = sum / sumw;
                sae += Math.abs(prices[i] - y);
                nwe.push(y);
            }
            sae = (sae / minLength) * mult;
            return { nwe, sae };
        }

        // Получение данных через WebSocket Binance
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/ldousdt@kline_15m');
        const prices = [];
        const timestamps = [];

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.k) {
                const closePrice = parseFloat(data.k.c);
                const timestamp = new Date(data.k.t).toLocaleTimeString();

                prices.push(closePrice);
                timestamps.push(timestamp);

                if (prices.length > 500) {
                    prices.shift();
                    timestamps.shift();
                }

                const { nwe, sae } = calculateNWE(prices);
                const upper = nwe.map(v => v + sae);
                const lower = nwe.map(v => v - sae);

                // Обновление графика
                chart.data.labels = timestamps;
                chart.data.datasets[0].data = prices;
                chart.data.datasets[1].data = upper;
                chart.data.datasets[2].data = lower;
                chart.update();
            }
        };

        ws.onerror = (error) => console.error('WebSocket error:', error);
    </script>
</body>
</html>
